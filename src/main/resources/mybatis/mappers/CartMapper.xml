<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.recipe.gola.mapper.CartMapper">

	<resultMap id="ProductDTO" type="ProductDTO">
	 	<result column="pName" property="pName" />
	 	<result column="pKind" property="pKind" />
		<result column="pPrice" property="pPrice" />
		<result column="pPoints" property="pPoints" />
		<result column="pContent" property="pContent" />
		<result column="pImage" property="pImage" />
		<result column="pRegdate" property="pRegdate" />
	</resultMap>

	<resultMap id="cartlist" type="CartDTO">
	 	<result column="cno" property="cno" />
	 	<result column="userId" property="userId" />
	 	<result column="pno" property="pno" />
		<result column="camount" property="camount" />
		<collection property="ProductDTO" resultMap="ProductDTO" />
	</resultMap>
	
	<!-- 내가 담은 장바구니 목록 조회 -->
	<select id="list" parameterType="String" resultType="CartDTO" resultMap="cartlist">
	<![CDATA[
		SELECT
			c.cno,
			c.userId,
			c.camount,
			p.pno,
			p.pName,
			p.pKind,
			p.pPrice,
			p.pPoints,
			p.pContent,
			p.pImage,
			p.pRegdate
		FROM cart c
			INNER JOIN product p
			ON c.pno = p.pno
		WHERE userId = #{userId}
	]]>
	</select>

<!-- 내가 선택한 장바구니 목록 조회 -->
	<select id="list2" parameterType="ProductDTO" resultType="CartDTO" resultMap="cartlist">
		SELECT
			c.cno,
			c.userId,
			c.camount,
			p.pno,
			p.pName,
			p.pKind,
			p.pPrice,
			p.pPoints,
			p.pContent,
			p.pImage,
			p.pRegdate
		FROM cart c
			INNER JOIN product p
			ON c.pno = p.pno
		WHERE userId = #{userId}
		AND p.pno IN
		<!-- 장바구니에서 내가 선택한 상품만 주문페이지에서 조회한다.  -->
		<foreach collection="pnos" item="array" open="(" close=")" separator=",">
			#{array}
		</foreach>
	</select>
	
	<!-- 내가 담은 장바구니 목록 조회 -->
	<select id="cartlist" parameterType="String" resultType="CartDTO">
	<![CDATA[
		SELECT *
		FROM cart
		WHERE userId = #{userId}
	]]>
	</select>
	
	<!-- 장바구니에 물건 담기 -->
	<insert id="insert" parameterType="CartDTO">
	<![CDATA[
		INSERT INTO 
		cart (cno, userId, pno, camount)
        VALUES (cno, #{userId}, #{pno}, #{camount})
    ]]>
    </insert>
    
    <!-- 장바구니에 동일한 상품이 있는지 확인 -->
    <select id="countCart" resultType="int">
    <![CDATA[
    	SELECT COUNT(*)
    	FROM cart
    	WHERE userId = #{userId}
    	AND pno = #{pno}
    ]]>
    </select>
    
    <!-- 장바구니에 동일한 상품이 존재하면 수정 -->
    <update id="update">
    <![CDATA[
    	UPDATE cart
    	SET camount = camount + #{camount}
    	WHERE userId = #{userId}
    	AND pno = #{pno}
    ]]>
    </update>
    
    <!-- 장바구니 전체 금액 -->
    <select id="sumMoney" resultType="int">
    <![CDATA[
    	SELECT IFNULL(SUM(pPrice * camount), 0) AS sumMoney
    	FROM product p, cart c
    	WHERE c.pno = p.pno AND c.userId = #{userId}
    ]]>
    </select>

    <!-- 장바구니 전체 금액 -->
    <select id="sumMoney2" resultType="int"  parameterType="ProductDTO"  >
 
    	SELECT IFNULL(SUM(pPrice * camount), 0) AS sumMoney
    	FROM product p, cart c
    	WHERE c.pno = p.pno AND c.userId = #{userId}
		AND p.pno IN
		<!-- 장바구니에서 내가 선택한 상품만 주문페이지에서 조회한다.  -->
		<foreach collection="pnos" item="array" open="(" close=")" separator=",">
			#{array}
		</foreach>
 
    </select>
    
    <!-- 장바구니 수량 수정 -->
    <update id="modifyCount">
    <![CDATA[
    	UPDATE cart
    	SET camount = #{camount}
    	WHERE userId = #{userId}
    	AND pno = #{pno}
    ]]>
    </update>
    
    <!-- 장바구니 상품 삭제 -->
    <delete id="delete" parameterType="CartDTO">
    <![CDATA[
    	DELETE
    	FROM cart
    	WHERE userId = #{userId}
    	AND pno = #{pno}
    ]]>
    </delete>
  
</mapper>